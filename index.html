<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–°–ö–ê–ù–ï–† 412</title>

<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0,
               user-scalable=no, viewport-fit=cover">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="apple-touch-icon" href="icon412.png">
<link rel="manifest" href="manifest.json">

<script src="quagga.min.js"></script>

<style>
*{
  box-sizing:border-box;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}

html,body{
  margin:0;
  padding:0;
  height:100%;
  background:#f8f9fa;
  font-family:-apple-system,system-ui,sans-serif;
  overflow:hidden;
}

h2{
  margin:8px 0;
  text-align:center;
  font-size:20px;
  font-weight:700;
}

#interactive.viewport{
  width:calc(100% - 20px);
  max-width:600px;
  height:22vh;
  margin:0 auto 6px;
  background:#000;
  border-radius:12px;
  overflow:hidden;
}

#interactive video,
#interactive canvas{
  width:100%;
  height:100%;
  object-fit:cover;
}

.manual-input-group{
  max-width:600px;
  margin:auto;
  padding:4px 12px;
  display:flex;
  gap:8px;
}

#manualInput{
  flex:1;
  font-size:18px;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
  user-select:text;
}

#addBtn{
  padding:0 18px;
  font-size:20px;
  background:#4caf50;
  color:#fff;
  border:none;
  border-radius:10px;
}

.status-bar{
  max-width:600px;
  margin:2px auto;
  padding:0 12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

#counter{
  font-weight:700;
}

.toggle-btn{
  padding:6px 12px;
  border-radius:8px;
  font-size:12px;
  font-weight:600;
  border:1px solid #ced4da;
  background:#e9ecef;
}

.toggle-btn.active{
  background:#007bff;
  color:#fff;
}

textarea{
  width:calc(100% - 24px);
  max-width:600px;
  height:130px;
  margin:5px auto;
  display:block;
  padding:12px;
  border-radius:12px;
  border:1px solid #ced4da;
  font-size:16px;
  resize:none;
  font-family:monospace;
  user-select:text;
}

.controls{
  max-width:600px;
  margin:6px auto;
  padding:0 12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.row{
  display:flex;
  gap:8px;
}

button{
  height:54px;
  border-radius:12px;
  border:1px solid #ced4da;
  font-size:16px;
  font-weight:700;
  background:#fff;
}

#torchBtn{
  flex:1.2;
  background:#fff3cd;
}

#reloadBtn{ flex:.8; background:#e7f3ff; }
#undoBtn{ flex:.8; background:#f8f9fa; }

#copyBtn{
  background:#d4edda;
  border-color:#c3e6cb;
}

#clearAllBtn{
  background:#fff5f5;
  border-color:#fad2cf;
  color:#d93025;
}

.credits{
  text-align:center;
  font-size:10px;
  color:#adb5bd;
  padding-bottom:12px;
}
</style>
</head>

<body>

<h2>–°–ö–ê–ù–ï–† 412</h2>

<div id="interactive" class="viewport"></div>

<audio id="beep" preload="auto">
  <source src="beep.mp3" type="audio/mpeg">
</audio>

<div class="manual-input-group">
  <input id="manualInput" type="tel" placeholder="–í—Ä—É—á–Ω—É..." inputmode="numeric">
  <button id="addBtn">‚ûï</button>
</div>

<div class="status-bar">
  <div id="counter">–í—Å—å–æ–≥–æ: 0</div>
  <div id="formatToggle" class="toggle-btn">–°—Ç–æ–≤–ø—á–∏–∫</div>
</div>

<textarea id="result" readonly placeholder="–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π..."></textarea>

<div class="controls">
  <div class="row">
    <button id="torchBtn">üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫</button>
    <button id="reloadBtn">üîÑ –ö–∞–º–µ—Ä–∞</button>
    <button id="undoBtn">‚Ü© –ù–∞–∑–∞–¥</button>
  </div>

  <button id="copyBtn">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤—Å–µ</button>
  <button id="clearAllBtn">üóë –û—á–∏—Å—Ç–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
</div>

<div class="credits">
  Created by Oleksii Zhuravko ¬∑ idea Vitalii Tupchienko
</div>

<script>
const STORAGE_KEY = "scanner412_codes";
const scannedCodes = new Set();

let isTorchOn = false;
let useCommaSeparator = false;
let lastDetected = null;
let detectCount = 0;

function startQuagga(){
  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:document.querySelector("#interactive"),
      constraints:{
        facingMode:"environment",
        width:{ideal:1280},
        height:{ideal:720}
      }
    },
    decoder:{
      readers:["code_128_reader","code_39_reader"]
    }
  },err=>{
    if(err) return;
    Quagga.start();
  });
}

document.getElementById("torchBtn").onclick = async () => {
  const track = Quagga.CameraAccess.getActiveTrack();
  if(!track) return;

  isTorchOn = !isTorchOn;

  try{
    await track.applyConstraints({
      advanced:[{ torch:isTorchOn }]
    });

    torchBtn.innerHTML = isTorchOn ? "üî¶ –í–∏–º–∫–Ω—É—Ç–∏" : "üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫";
    torchBtn.style.background = isTorchOn ? "#ffeb3b" : "#fff3cd";

  }catch(e){
    console.warn("Torch not supported", e);
  }
};

Quagga.onDetected(data=>{
  const code = data.codeResult.code;
  if(code === lastDetected) detectCount++;
  else { lastDetected = code; detectCount = 1; }

  if(detectCount >= 3){
    addCode(code);
    detectCount = 0;
    lastDetected = null;
  }
});

function addCode(code){
  code = code.trim();
  if(!code || scannedCodes.has(code)) return;

  scannedCodes.add(code);
  updateUI();

  navigator.vibrate?.(80);
  beep.play().catch(()=>{});
}

function updateUI(){
  const arr = [...scannedCodes];
  result.value = arr.join(useCommaSeparator ? ", " : "\n");
  counter.textContent = `–í—Å—å–æ–≥–æ: ${scannedCodes.size}`;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}

addBtn.onclick = () => {
  if(manualInput.value){
    addCode(manualInput.value);
    manualInput.value="";
  }
};

undoBtn.onclick = () => {
  const arr=[...scannedCodes];
  arr.pop();
  scannedCodes.clear();
  arr.forEach(v=>scannedCodes.add(v));
  updateUI();
};

formatToggle.onclick = function(){
  useCommaSeparator = !useCommaSeparator;
  this.classList.toggle("active",useCommaSeparator);
  this.innerText = useCommaSeparator ? "–ö–æ–º–∞" : "–°—Ç–æ–≤–ø—á–∏–∫";
  updateUI();
};

copyBtn.onclick = async () => {
  if(!result.value) return;
  await navigator.clipboard.writeText(result.value);
  copyBtn.innerText="‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ";
  setTimeout(()=>copyBtn.innerText="üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤—Å–µ",1500);
};

clearAllBtn.onclick = () => {
  if(confirm("–û—á–∏—Å—Ç–∏—Ç–∏ —Å–ø–∏—Å–æ–∫?")){
    scannedCodes.clear();
    updateUI();
  }
};

reloadBtn.onclick = () => {
  isTorchOn = false;
  torchBtn.innerHTML="üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫";
  torchBtn.style.background="#fff3cd";
  Quagga.stop();
  startQuagga();
};

const saved = localStorage.getItem(STORAGE_KEY);
if(saved){
  JSON.parse(saved).forEach(v=>scannedCodes.add(v));
  updateUI();
}

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}

startQuagga();
</script>
</body>
</html>
