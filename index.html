<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–°–ö–ê–ù–ï–† 412</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f8f9fa">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="zxing.js"></script>

    <style>
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; overscroll-behavior: none; }

        body {
            font-family: 'Inter', -apple-system, sans-serif; 
            padding: 10px 15px; background: #f8f9fa;
            display: flex; flex-direction: column; align-items: center; touch-action: none; 
        }

        h2 { margin: 5px 0 10px 0; font-weight: 700; letter-spacing: -0.03em; color: #1a1a1a; }

        video {
            width: 100%; max-width: 600px; height: 25vh; border-radius: 12px;
            margin-bottom: 10px; object-fit: cover; background: #000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .manual-input-group { width: 100%; max-width: 600px; display: flex; gap: 8px; margin-bottom: 10px; }

        #manualInput {
            flex: 1; padding: 12px; font-size: 16px; border-radius: 10px;
            border: 1.5px solid #dee2e6; -webkit-user-select: text; user-select: text;
            background: #fff; font-family: 'Inter', sans-serif;
        }

        #addBtn { width: auto; padding: 0 20px; background: #4CAF50; color: white; border: none; font-size: 20px; border-radius: 10px; }

        #counter { font-weight: 600; margin-bottom: 5px; color: #495057; font-size: 13px; text-transform: uppercase; }

        textarea {
            width: 100%; max-width: 600px; height: 140px;
            font-size: 16px; margin-bottom: 10px; white-space: pre;
            border: 1.5px solid #dee2e6; border-radius: 12px; padding: 12px; resize: none;
            -webkit-user-select: text; user-select: text; touch-action: pan-y; 
            background: #fff; font-family: 'Inter', sans-serif;
        }

        .controls { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 8px; }
        .row-btns { display: flex; gap: 8px; width: 100%; }
        .row-btns button { flex: 1; }

        button {
            padding: 14px; width: 100%; font-size: 15px; font-weight: 600; cursor: pointer;
            border-radius: 12px; border: 1px solid #dee2e6; background: #fff;
            font-family: 'Inter', sans-serif; transition: all 0.2s;
        }

        #torchBtn { display: none; background: #fff3cd; color: #856404; }
        #undoBtn { background: #f8f9fa; color: #495057; }
        #undoBtn:disabled { opacity: 0.5; cursor: not-allowed; }

        #modalOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-content { background: white; padding: 24px; border-radius: 16px; width: 85%; max-width: 400px; text-align: center; }
        .modal-btns { display: flex; gap: 10px; margin-top: 24px; }
        .btn-confirm { background: #ff4d4d; color: white; border: none; }
        .btn-cancel { background: #f1f3f5; border: none; }
    </style>
</head>
<body>

<h2>–°–ö–ê–ù–ï–† 412</h2>

<video id="video"></video>

<div class="manual-input-group">
    <input type="tel" id="manualInput" placeholder="–¶–∏—Ñ—Ä–∏ –≤—Ä—É—á–Ω—É..." autocomplete="off" inputmode="numeric">
    <button id="addBtn" onclick="addManualCode()">‚ûï</button>
</div>

<div id="counter">–í—Å—å–æ–≥–æ: 0</div>
<textarea id="result" readonly placeholder="–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π..."></textarea>

<div class="controls">
    <div class="row-btns">
        <button id="torchBtn" onclick="toggleTorch()">üî¶ –°–≤—ñ—Ç–ª–æ</button>
        <button id="undoBtn" onclick="undoLastScan()">‚Ü©Ô∏è –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
    <button onclick="copyData(event)" id="copyBtn" style="background: #e7f3ff; color: #0056b3; border-color: #cfe2ff;">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤—Å–µ</button>
    <button onclick="showClearModal()" style="color: #d93025; background: #fff5f5; border-color: #fad2cf;">üóë –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
</div>

<div id="modalOverlay">
    <div class="modal-content">
        <h3 style="margin: 0 0 10px 0;">–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å–µ?</h3>
        <p style="color: #6c757d; font-size: 14px;">–¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏.</p>
        <div class="modal-btns">
            <button class="btn-cancel" onclick="closeModal()">–ù–∞–∑–∞–¥</button>
            <button class="btn-confirm" onclick="confirmClear()">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </div>
    </div>
</div>

<script>
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

    const manualInput = document.getElementById('manualInput');
    const undoBtn = document.getElementById('undoBtn');
    
    manualInput.addEventListener('blur', () => {
        setTimeout(() => { window.scrollTo({ top: 0, left: 0, behavior: 'smooth' }); }, 150);
    });

    const STORAGE_KEY = 'scanner412_codes';
    const codeReader = new ZXing.BrowserBarcodeReader();
    const videoElement = document.getElementById('video');
    const resultField = document.getElementById('result');
    const counter = document.getElementById('counter');
    const torchBtn = document.getElementById('torchBtn');

    let scannedCodes = []; // –ó–º—ñ–Ω—é—î–º–æ –Ω–∞ –º–∞—Å–∏–≤ –¥–ª—è –∑—Ä—É—á–Ω–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ
    let scanTimeout = false;
    let videoStream = null;
    let isTorchOn = false;

    function updateDisplay() {
        resultField.value = scannedCodes.join('\n');
        counter.textContent = `–í—Å—å–æ–≥–æ: ${scannedCodes.length}`;
        undoBtn.disabled = scannedCodes.length === 0;
        resultField.scrollTop = resultField.scrollHeight;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(scannedCodes));
    }

    const savedData = localStorage.getItem(STORAGE_KEY);
    if (savedData) {
        scannedCodes = JSON.parse(savedData);
        updateDisplay();
    }

    function vibrateDevice(pattern = 100) {
        if ("vibrate" in navigator) navigator.vibrate(pattern);
    }

    function processCode(code) {
        code = code.trim();
        if (!code || scannedCodes.includes(code)) return false;
        scannedCodes.push(code);
        updateDisplay();
        vibrateDevice();
        return true;
    }

    function undoLastScan() {
        if (scannedCodes.length > 0) {
            scannedCodes.pop();
            updateDisplay();
            vibrateDevice(50);
        }
    }

    function addManualCode() {
        if (processCode(manualInput.value)) {
            manualInput.value = '';
            manualInput.blur();
        }
    }

    codeReader.decodeFromVideoDevice(null, videoElement, (result, err) => {
        if (!videoStream && videoElement.srcObject) {
            videoStream = videoElement.srcObject;
            setTimeout(checkTorchSupport, 1000);
        }
        if (result && !scanTimeout) {
            if (processCode(result.text)) {
                scanTimeout = true;
                setTimeout(() => scanTimeout = false, 1500);
            }
        }
    });

    async function checkTorchSupport() {
        try {
            const track = videoStream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();
            if (capabilities && capabilities.torch) torchBtn.style.display = 'block';
        } catch (e) {}
    }

    async function toggleTorch() {
        try {
            const track = videoStream.getVideoTracks()[0];
            isTorchOn = !isTorchOn;
            await track.applyConstraints({ advanced: [{ torch: isTorchOn }] });
            torchBtn.innerText = isTorchOn ? "üî¶ –£–≤—ñ–º–∫" : "üî¶ –°–≤—ñ—Ç–ª–æ";
            torchBtn.style.background = isTorchOn ? "#ffc107" : "#fff3cd";
        } catch (e) {}
    }

    function copyData(event) {
        const btn = event.currentTarget;
        if (!resultField.value) return;
        navigator.clipboard.writeText(resultField.value).then(() => {
            const oldText = btn.innerText;
            btn.innerText = "‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!";
            btn.style.background = "#d4edda";
            setTimeout(() => {
                btn.innerText = oldText;
                btn.style.background = "#e7f3ff";
            }, 2000);
        });
    }

    function showClearModal() { document.getElementById('modalOverlay').style.display = 'flex'; }
    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
    function confirmClear() {
        scannedCodes = [];
        updateDisplay();
        localStorage.removeItem(STORAGE_KEY);
        closeModal();
    }
</script>
</body>
</html>

