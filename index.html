<!DOCTYPE html> 
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–°–ö–ê–ù–ï–† 412 PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon412.png">
    <link rel="manifest" href="manifest.json">
    <script src="quagga.min.js"></script>

    <style>
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        html, body { margin:0; padding:0; overflow:hidden; height:100%; font-family: -apple-system, system-ui, sans-serif; background:#f8f9fa; }
        h2 { text-align:center; margin:8px 0; font-weight:700; color: #1a1a1a; font-size: 20px; }

        #interactive.viewport {
            width: calc(100% - 20px); max-width: 600px; height: 22vh; 
            margin: 0 auto 5px; overflow: hidden; position: relative;
            background: #000; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #interactive.viewport > video, #interactive.viewport > canvas { width: 100%; height: 100%; object-fit: cover; }
        
        .manual-input-group { max-width:600px; margin:auto; display:flex; gap:8px; padding:5px 12px; }
        #manualInput { flex:1; font-size:18px; padding:12px; border-radius:10px; border:1px solid #ccc; user-select:text; outline:none; }
        #addBtn { padding:0 20px; border-radius:10px; border:none; background:#4caf50; color:white; font-size:20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .status-bar { max-width: 600px; margin: 2px auto; padding: 0 12px; display: flex; justify-content: space-between; align-items: center; }
        #counter { font-size: 15px; font-weight: 700; color: #495057; }
        
        .toggle-btn {
            background: #e9ecef; border: 1px solid #ced4da; padding: 6px 12px;
            border-radius: 8px; font-size: 12px; font-weight: 600; color: #495057;
            display: flex; align-items: center; justify-content: center;
        }
        .toggle-btn.active { background: #007bff; color: white; border-color: #007bff; }

        textarea {
            width: calc(100% - 24px); max-width:600px; height: 130px; margin:5px auto; display:block; padding:12px;
            border-radius:12px; border:1px solid #ced4da; font-size:17px; resize:none; background:white;
            user-select:text; font-family: monospace;
        }

        .controls { max-width:600px; margin:5px auto; display:flex; flex-direction:column; gap:8px; padding:0 12px; }
        .row { display:flex; gap:8px; width: 100%; }
        
        /* –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–æ–∫ */
        button { 
            height: 54px; /* –§—ñ–∫—Å–æ–≤–∞–Ω–∞ –≤–∏—Å–æ—Ç–∞ –¥–ª—è —ñ–¥–µ–∞–ª—å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è */
            padding: 0 10px; 
            border-radius: 12px; 
            border: 1px solid #ced4da; 
            font-weight: 700; 
            font-size: 16px; 
            background: white; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            line-height: 1;
        }
        
        #torchBtn { display:none; background:#fff3cd; flex: 1.2; }
        #reloadBtn { background:#e7f3ff; flex: 0.8; }
        #undoBtn { background:#f8f9fa; flex: 0.8; }
        #copyBtn { background: #d4edda; color: #155724; border-color: #c3e6cb; width: 100%; }
        .clearBtn { background:#fff5f5; color:#d93025; border-color:#fad2cf; width: 100%; }

        .credits { text-align: center; font-size: 10px; color: #adb5bd; margin-top: 10px; padding-bottom: 15px; }
    </style>
</head>
<body>

<h2>–°–ö–ê–ù–ï–† 412</h2>

<div id="interactive" class="viewport"></div>

<audio id="beep" preload="auto">
  <source src="beep.mp3" type="audio/mpeg">
</audio>

<div class="manual-input-group">
    <input id="manualInput" type="tel" placeholder="–í—Ä—É—á–Ω—É..." inputmode="numeric">
    <button id="addBtn">‚ûï</button>
</div>

<div class="status-bar">
    <div id="counter">–í—Å—å–æ–≥–æ: 0</div>
    <div id="formatToggle" class="toggle-btn">–°—Ç–æ–≤–ø—á–∏–∫</div>
</div>

<textarea id="result" readonly placeholder="–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π..."></textarea>

<div class="controls">
    <div class="row">
        <button id="torchBtn">üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫</button>
        <button id="reloadBtn">üîÑ –ö–∞–º–µ—Ä–∞</button>
        <button id="undoBtn">‚Ü© –ù–∞–∑–∞–¥</button>
    </div>
    <button id="copyBtn">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤—Å–µ</button>
    <button class="clearBtn" id="clearAllBtn">üóë –û—á–∏—Å—Ç–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
</div>

<div class="credits">
    Created by Oleksii Zhuravko, idea Vitalii Tupchienko
</div>

<script>
const STORAGE_KEY = "scanner412_codes";
const scannedCodes = new Set();
let isTorchOn = false;
let useCommaSeparator = false;
let lastDetectedCode = null;
let detectionCount = 0;

function startQuagga() {
    Quagga.init({
        inputStream: {
            name: "Live", type: "LiveStream", target: document.querySelector('#interactive'),
            constraints: { 
                facingMode: "environment", 
                width: { min: 640, ideal: 1280 }, 
                height: { min: 480, ideal: 720 },
                aspectRatio: { ideal: 1.777 }
            },
        },
        locator: { patchSize: "medium", halfSample: true },
        decoder: { readers: ["code_128_reader", "code_39_reader"] }
    }, function(err) {
        if (err) return;
        Quagga.start();
        checkTorchSupport();
    });
}

function checkTorchSupport() {
    let attempts = 0;
    const interval = setInterval(() => {
        const track = Quagga.CameraAccess.getActiveTrack();
        if (track) {
            const caps = track.getCapabilities ? track.getCapabilities() : {};
            if (caps.torch) {
                document.getElementById("torchBtn").style.display = "flex";
                clearInterval(interval);
            }
        }
        if (++attempts > 15) clearInterval(interval);
    }, 500);
}

function processCode(code) {
    code = code.trim();
    if (!code || scannedCodes.has(code)) return false;
    scannedCodes.add(code);
    updateUI();
    if ("vibrate" in navigator) navigator.vibrate(80);
    document.getElementById("beep").play().catch(()=>{});
    return true;
}

document.getElementById("addBtn").onclick = () => {
    const input = document.getElementById("manualInput");
    if (processCode(input.value)) {
        input.value = "";
        input.blur();
    }
};

document.getElementById("reloadBtn").onclick = () => {
    isTorchOn = false;
    document.getElementById("torchBtn").innerHTML = "üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫";
    document.getElementById("torchBtn").style.background = "#fff3cd";
    Quagga.stop();
    startQuagga();
};

document.getElementById("torchBtn").onclick = async function() {
    const track = Quagga.CameraAccess.getActiveTrack();
    if (track) {
        try {
            isTorchOn = !isTorchOn;
            await track.applyConstraints({ advanced: [{ torch: isTorchOn }] });
            this.innerHTML = isTorchOn ? "üî¶ –í–∏–º–∫–Ω—É—Ç–∏" : "üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫";
            this.style.background = isTorchOn ? "#ffeb3b" : "#fff3cd";
        } catch (e) { console.error(e); }
    }
};

document.getElementById("formatToggle").onclick = function() {
    useCommaSeparator = !useCommaSeparator;
    this.classList.toggle("active", useCommaSeparator);
    this.innerText = useCommaSeparator ? "–ö–æ–º–∞" : "–°—Ç–æ–≤–ø—á–∏–∫";
    updateUI();
};

Quagga.onDetected((data) => {
    const code = data.codeResult.code;
    if (code.length < 3 || code.length > 8) return;
    if (code === lastDetectedCode) { detectionCount++; } 
    else { lastDetectedCode = code; detectionCount = 0; }
    
    if (detectionCount >= 3) {
        processCode(code);
        detectionCount = 0;
        lastDetectedCode = null;
    }
});

function updateUI() {
    const arr = Array.from(scannedCodes);
    document.getElementById("result").value = arr.join(useCommaSeparator ? ", " : "\n");
    document.getElementById("counter").textContent = `–í—Å—å–æ–≥–æ: ${scannedCodes.size}`;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}

document.getElementById("undoBtn").onclick = () => {
    const arr = Array.from(scannedCodes);
    if (arr.length > 0) {
        arr.pop();
        scannedCodes.clear();
        arr.forEach(v => scannedCodes.add(v));
        updateUI();
    }
};

document.getElementById("copyBtn").onclick = function() {
    const text = document.getElementById("result").value;
    if (!text) return;
    navigator.clipboard.writeText(text);
    const old = this.innerText;
    this.innerText = "‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!";
    setTimeout(() => this.innerText = old, 1500);
};

// –í–ò–ü–†–ê–í–õ–ï–ù–û: –¥–æ–¥–∞–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä–∏ –ø—ñ—Å–ª—è confirm
document.getElementById("clearAllBtn").onclick = () => {
    if(confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫?")) { 
        scannedCodes.clear(); 
        updateUI(); 
    }
    // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Quagga –¥–ª—è Android
    setTimeout(() => {
        Quagga.stop();
        startQuagga();
    }, 100);
};

const saved = localStorage.getItem(STORAGE_KEY);
if (saved) { JSON.parse(saved).forEach(v => scannedCodes.add(v)); updateUI(); }

if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

startQuagga();
</script>
</body>
</html>
