<!DOCTYPE html> 
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–°–ö–ê–ù–ï–† 412 PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <style>
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        html, body { margin:0; padding:0; overflow:hidden; height:100%; font-family: -apple-system, system-ui, sans-serif; background:#f8f9fa; }

        h2 { text-align:center; margin:10px 0; font-weight:700; color: #1a1a1a; font-size: 24px; }

        /* –ü–æ–≤–µ—Ä–Ω—É–≤ —Ä–æ–∑–º—ñ—Ä –≤—ñ–¥–µ–æ —è–∫ –±—É–ª–æ */
        #interactive.viewport {
            width: 100%; max-width: 600px; height: 22vh; 
            margin: auto; overflow: hidden; position: relative;
            background: #000; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #interactive.viewport > video, #interactive.viewport > canvas {
            width: 100%; height: 100%; object-fit: cover;
        }
        canvas.drawingBuffer { position: absolute; left: 0; top: 0; }

        .manual-input-group { max-width:600px; margin:auto; display:flex; gap:10px; padding:10px 12px 0; }
        #manualInput { flex:1; font-size:18px; padding:15px; border-radius:12px; border:1px solid #ccc; user-select:text; }
        #addBtn { padding:0 25px; border-radius:12px; border:none; background:#4caf50; color:white; font-size:24px; cursor: pointer; }

        #counter { text-align:center; margin:10px 0; font-size:16px; font-weight:700; color: #495057; }

        textarea {
            width: calc(100% - 24px); max-width:600px; height: 160px; margin:auto; display:block; padding:15px;
            border-radius:12px; border:1px solid #ced4da; font-size:18px; resize:none; background:white;
            user-select:text; white-space:pre; font-family: monospace;
        }

        /* –ü–æ–≤–µ—Ä–Ω—É–≤ –≤–µ–ª–∏–∫—ñ –∫–Ω–æ–ø–∫–∏ */
        .controls { max-width:600px; margin:10px auto; display:flex; flex-direction:column; gap:10px; padding:0 12px; }
        .row { display:flex; gap:10px; width: 100%; }
        
        button { 
            padding: 18px; border-radius: 14px; border: 1px solid #ced4da; 
            font-weight: 700; font-size: 18px; background: white; 
            cursor: pointer; transition: transform 0.1s, opacity 0.2s;
        }
        
        button:active { transform: scale(0.98); opacity: 0.8; }

        #torchBtn, #undoBtn { flex: 1; }
        #torchBtn { display:none; background:#fff3cd; border-color:#ffeeba; color:#856404; justify-content: center; align-items: center; }
        #undoBtn { background:#e9ecef; }
        #copyBtn { background:#e7f3ff; border-color:#cfe2ff; color:#0056b3; }
        .clearBtn { background:#fff5f5; border-color:#fad2cf; color:#d93025; }

        #modal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;
            backdrop-filter: blur(4px);
        }
        .modal-box {
            background:white; padding:25px; border-radius:20px; text-align:center; width:85%; max-width:400px;
        }
    </style>
</head>
<body>

<h2>–°–ö–ê–ù–ï–† 412</h2>

<div id="interactive" class="viewport"></div>

<audio id="beep" preload="auto">
  <source src="https://raw.githubusercontent.com/renzofiorella/barcode-scanner-pwa/master/src/assets/beep.mp3" type="audio/mpeg">
</audio>

<div class="manual-input-group">
    <input id="manualInput" type="tel" placeholder="–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É..." inputmode="numeric">
    <button id="addBtn">‚ûï</button>
</div>

<div id="counter">–í—Å—å–æ–≥–æ –≤—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω–æ: 0</div>

<textarea id="result" readonly placeholder="–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π..."></textarea>

<div class="controls">
    <div class="row">
        <button id="torchBtn">üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫</button>
        <button id="undoBtn">‚Ü© –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
    <button id="copyBtn">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤—Å–µ</button>
    <button class="clearBtn" id="clearAllBtn">üóë –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
</div>

<div id="modal">
    <div class="modal-box">
        <h3 style="margin-top:0">–û—á–∏—Å—Ç–∏—Ç–∏ —Å–ø–∏—Å–æ–∫?</h3>
        <p style="color:#666">–í—Å—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ –±–µ–∑–ø–æ–≤–æ—Ä–æ—Ç–Ω–æ.</p>
        <div class="row">
            <button onclick="closeModal()" style="flex:1">–ù–∞–∑–∞–¥</button>
            <button onclick="confirmClear()" style="flex:1; background:#ff4d4d; color:white; border:none">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </div>
    </div>
</div>

<script>
const STORAGE_KEY = "scanner412_codes";
const scannedCodes = new Set();
let isTorchOn = false;

// –ó–º—ñ–Ω–Ω—ñ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –ø–æ–º–∏–ª–æ–∫
let lastDetectedCode = null;
let detectionCount = 0;
const REQUIRED_CONFIRMATIONS = 3; // –°–∫—ñ–ª—å–∫–∏ —Ä–∞–∑—ñ–≤ –ø–æ—Å–ø—ñ–ª—å —Ç—Ä–µ–±–∞ –ø–æ–±–∞—á–∏—Ç–∏ –∫–æ–¥

function startQuagga() {
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#interactive'),
            constraints: {
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            },
        },
        locator: {
            patchSize: "medium", // Medium –∫—Ä–∞—â–µ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –∫–æ–¥—ñ–≤, –Ω—ñ–∂ Large
            halfSample: true
        },
        decoder: {
            // –ó–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ Code 128 —Ç–∞ Code 39 –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç—ñ
            readers: ["code_128_reader", "code_39_reader"]
        }
    }, function(err) {
        if (err) { console.error(err); return; }
        Quagga.start();
        
        setTimeout(() => {
            const track = Quagga.CameraAccess.getActiveTrack();
            if (track && track.getCapabilities) {
                const caps = track.getCapabilities();
                if (caps.torch) document.getElementById("torchBtn").style.display = "flex";
            }
        }, 1500);
    });
}

Quagga.onDetected((data) => {
    const code = data.codeResult.code;

    // 1. –§—ñ–ª—å—Ç—Ä –¥–æ–≤–∂–∏–Ω–∏ (—ñ–≥–Ω–æ—Ä—É—î–º–æ –≤—Å–µ, —â–æ –Ω–µ –≤ –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ 3-6 —Å–∏–º–≤–æ–ª—ñ–≤)
    if (code.length < 3 || code.length > 5) return;

    // 2. –§—ñ–ª—å—Ç—Ä —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ (–∫–æ–¥ –º–∞—î –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏—Å—è –∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤)
    if (code === lastDetectedCode) {
        detectionCount++;
    } else {
        lastDetectedCode = code;
        detectionCount = 0;
    }

    if (detectionCount >= REQUIRED_CONFIRMATIONS) {
        process(code);
        detectionCount = 0; // –°–∫–∏–¥–∞—î–º–æ –ø—ñ—Å–ª—è —É—Å–ø—ñ—Ö—É
        lastDetectedCode = null;
    }
});

function process(code) {
    code = code.trim();
    // –§—ñ–Ω–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º
    if (!code || scannedCodes.has(code)) return false;
    
    scannedCodes.add(code);
    updateUI();
    
    if ("vibrate" in navigator) navigator.vibrate(80);
    const audio = document.getElementById("beep");
    if (audio) { audio.currentTime = 0; audio.play().catch(()=>{}); }
    
    return true;
}

function updateUI() {
    document.getElementById("result").value = Array.from(scannedCodes).join("\n");
    document.getElementById("counter").textContent = `–í—Å—å–æ–≥–æ –≤—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω–æ: ${scannedCodes.size}`;
    document.getElementById("result").scrollTop = document.getElementById("result").scrollHeight;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(scannedCodes)));
}

// –†–µ—à—Ç–∞ –∫–Ω–æ–ø–æ–∫ (–õ—ñ—Ö—Ç–∞—Ä–∏–∫, –ö–æ–ø—ñ—é–≤–∞—Ç–∏, –û—á–∏—Å—Ç–∏—Ç–∏) –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω...
document.getElementById("torchBtn").onclick = function() {
    const track = Quagga.CameraAccess.getActiveTrack();
    isTorchOn = !isTorchOn;
    track.applyConstraints({ advanced: [{ torch: isTorchOn }] });
    this.innerHTML = isTorchOn ? "üî¶ –í–∏–º–∫–Ω—É—Ç–∏" : "üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫";
};

document.getElementById("addBtn").onclick = () => {
    const val = document.getElementById("manualInput").value.trim();
    if (process(val)) {
        document.getElementById("manualInput").value = "";
        document.getElementById("manualInput").blur();
    }
};

document.getElementById("undoBtn").onclick = () => {
    const arr = Array.from(scannedCodes);
    if (arr.length > 0) {
        arr.pop();
        scannedCodes.clear();
        arr.forEach(v => scannedCodes.add(v));
        updateUI();
    }
};

document.getElementById("copyBtn").onclick = function() {
    const text = document.getElementById("result").value;
    if (!text) return;
    navigator.clipboard.writeText(text);
    const oldText = this.innerText;
    this.innerText = "‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!";
    setTimeout(() => this.innerText = oldText, 1500);
};

document.getElementById("clearAllBtn").onclick = () => document.getElementById("modal").style.display = "flex";
function closeModal() { document.getElementById("modal").style.display = "none"; }
function confirmClear() { scannedCodes.clear(); updateUI(); closeModal(); }

const saved = localStorage.getItem(STORAGE_KEY);
if (saved) { JSON.parse(saved).forEach(v => scannedCodes.add(v)); updateUI(); }

startQuagga();

// –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –∑—É–º—É
document.addEventListener('touchstart', (e) => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
</script>
</body>
</html>



