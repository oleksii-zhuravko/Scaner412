<!DOCTYPE html> 
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–°–ö–ê–ù–ï–† 412</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="zxing.js"></script>

    <style>
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        html, body { margin:0; padding:0; overflow:hidden; height:100%; font-family: -apple-system, system-ui, sans-serif; background:#f8f9fa; }

        h2 { text-align:center; margin:10px 0; font-weight:700; color: #1a1a1a; font-size: 24px; }

        video {
            width: 100%; max-width: 600px; height: 22vh; border-radius: 12px;
            background:#000; margin:auto; display:block; object-fit:cover;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .manual-input-group { max-width:600px; margin:auto; display:flex; gap:10px; padding:10px 12px 0; }
        #manualInput { flex:1; font-size:18px; padding:15px; border-radius:12px; border:1px solid #ccc; user-select:text; }
        #addBtn { padding:0 25px; border-radius:12px; border:none; background:#4caf50; color:white; font-size:24px; cursor: pointer; }

        #counter { text-align:center; margin:10px 0; font-size:16px; font-weight:700; color: #495057; }

        textarea {
            width: calc(100% - 24px); max-width:600px; height: 160px; margin:auto; display:block; padding:15px;
            border-radius:12px; border:1px solid #ced4da; font-size:18px; resize:none; background:white;
            user-select:text; white-space:pre; font-family: monospace;
        }

        .controls { max-width:600px; margin:10px auto; display:flex; flex-direction:column; gap:10px; padding:0 12px; }

        .row { display:flex; gap:10px; width: 100%; }
        
        button { 
            padding: 18px; border-radius: 14px; border: 1px solid #ced4da; 
            font-weight: 700; font-size: 18px; background: white; 
            cursor: pointer; transition: transform 0.1s, opacity 0.2s;
        }
        
        button:active { transform: scale(0.98); opacity: 0.8; }

        #torchBtn, #undoBtn { flex: 1; }
        #torchBtn { display:none; background:#fff3cd; border-color:#ffeeba; color:#856404; justify-content: center; align-items: center; }
        #undoBtn { background:#e9ecef; }
        #copyBtn { background:#e7f3ff; border-color:#cfe2ff; color:#0056b3; }
        .clearBtn { background:#fff5f5; border-color:#fad2cf; color:#d93025; }

        /* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ */
        #modal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;
            backdrop-filter: blur(4px);
        }
        .modal-box {
            background:white; padding:25px; border-radius:20px; text-align:center; width:85%; max-width:400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<h2>–°–ö–ê–ù–ï–† 412</h2>

<video id="video" autoplay muted playsinline></video>

<audio id="beep" preload="auto">
  <source src="https://raw.githubusercontent.com/renzofiorella/barcode-scanner-pwa/master/src/assets/beep.mp3" type="audio/mpeg">
</audio>

<div class="manual-input-group">
    <input id="manualInput" type="tel" placeholder="–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É..." inputmode="numeric">
    <button id="addBtn">‚ûï</button>
</div>

<div id="counter">–í—Å—å–æ–≥–æ –≤—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω–æ: 0</div>

<textarea id="result" readonly placeholder="–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π..."></textarea>

<div class="controls">
    <div class="row">
        <button id="torchBtn">üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫</button>
        <button id="undoBtn">‚Ü© –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
    <button id="copyBtn">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤—Å–µ</button>
    <button class="clearBtn" id="clearAllBtn">üóë –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
</div>

<div id="modal">
    <div class="modal-box">
        <h3 style="margin-top:0">–û—á–∏—Å—Ç–∏—Ç–∏ —Å–ø–∏—Å–æ–∫?</h3>
        <p style="color:#666">–í—Å—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ –±–µ–∑–ø–æ–≤–æ—Ä–æ—Ç–Ω–æ.</p>
        <div class="row">
            <button onclick="closeModal()" style="flex:1">–ù–∞–∑–∞–¥</button>
            <button onclick="confirmClear()" style="flex:1; background:#ff4d4d; color:white; border:none">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </div>
    </div>
</div>

<script>
const STORAGE_KEY = "scanner412_codes";

// --- –†–û–ó–®–ò–†–ï–ù–Ü –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –î–õ–Ø –ß–ò–°–õ–û–í–ò–• –®–¢–†–ò–•-–ö–û–î–Ü–í ---
const hints = new Map();
const formats = [
    ZXing.BarcodeFormat.CODE_128, // –ù–∞–π–ø–æ–ø—É–ª—è—Ä–Ω—ñ—à–∏–π –¥–ª—è –ª–æ–≥—ñ—Å—Ç–∏–∫–∏ —Ç–∞ —Ü–∏—Ñ—Ä
    ZXing.BarcodeFormat.CODE_39,  // –°—Ç–∞—Ä–∏–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –ø—Ä–æ–º–∏—Å–ª–æ–≤–æ—Å—Ç—ñ
    ZXing.BarcodeFormat.EAN_13,   // –¢–æ–≤–∞—Ä–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö
    ZXing.BarcodeFormat.EAN_8,    // –ú–∞–ª—ñ —Ç–æ–≤–∞—Ä–∏
    ZXing.BarcodeFormat.ITF,      // –¢—ñ–ª—å–∫–∏ —Ü–∏—Ñ—Ä–∏ (—á–∞—Å—Ç–æ –Ω–∞ –∫–æ—Ä–æ–±–∫–∞—Ö)
    ZXing.BarcodeFormat.UPC_A     // –ê–º–µ—Ä–∏–∫–∞–Ω—Å—å–∫–∏–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç —Ü–∏—Ñ—Ä
];

hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
// üöÄ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è (—Å–ø–æ–∂–∏–≤–∞—î –±—ñ–ª—å—à–µ –±–∞—Ç–∞—Ä–µ—ó, –∞–ª–µ –±–∞—á–∏—Ç—å —Å–∫–ª–∞–¥–Ω—ñ –∫–æ–¥–∏)
hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
// –î–æ–ø–æ–º–∞–≥–∞—î —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ –∫–æ–¥, —è–∫—â–æ –≤—ñ–Ω –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∏–π –∞–±–æ –±–æ–∫–æ–º
hints.set(ZXing.DecodeHintType.ASSUME_CODE_39_CHECK_DIGIT, true);

const codeReader = new ZXing.BrowserBarcodeReader(hints);

// --- –û–ù–û–í–õ–ï–ù–ê –§–£–ù–ö–¶–Ü–Ø –ü–†–û–¶–ï–°–£ (—â–æ–± —Ç–æ—á–Ω–æ –±–∞—á–∏—Ç–∏ —á–∏—Å–ª–∞) ---
function process(code){
    // –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–π–≤—ñ –ø—Ä–æ–±—ñ–ª–∏ —Ç–∞ –Ω–µ–≤–∏–¥–∏–º—ñ —Å–∏–º–≤–æ–ª–∏
    code = code.trim().replace(/[^0-9A-Za-z]/g, ''); 
    
    if(!code || scannedCodes.has(code)) return false;
    
    scannedCodes.add(code);
    updateUI();
    vibrate(100); // –î–æ–≤—à–∏–π –≤—ñ–±—Ä–æ–≤—ñ–¥–≥—É–∫ –¥–ª—è –≤–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ
    beep();
    return true;
}
const video = document.getElementById("video");
const manualInput = document.getElementById("manualInput");
const resultField = document.getElementById("result");
const counter = document.getElementById("counter");
const torchBtn = document.getElementById("torchBtn");

let videoStream = null;
let isTorchOn = false;
let scanCooldown = false;
const scannedCodes = new Set();

if ('serviceWorker' in navigator) { 
    navigator.serviceWorker.register('sw.js').catch(err => console.log("SW error:", err)); 
}

manualInput.addEventListener('blur', () => {
    setTimeout(() => { window.scrollTo({ top: 0, left: 0, behavior: 'smooth' }); }, 150);
});

function beep(){
    const a = document.getElementById("beep");
    if(a) { a.currentTime = 0; a.play().catch(()=>{}); }
}

function updateUI(){
    resultField.value = Array.from(scannedCodes).join("\n");
    counter.textContent = `–í—Å—å–æ–≥–æ –≤—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω–æ: ${scannedCodes.size}`;
    resultField.scrollTop = resultField.scrollHeight;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(scannedCodes)));
}

function vibrate(ms = 60){ if("vibrate" in navigator) navigator.vibrate(ms); }

function process(code){
    code = code.trim();
    if(!code || scannedCodes.has(code)) return false;
    scannedCodes.add(code);
    updateUI();
    vibrate();
    beep();
    return true;
}

// –ü–ï–†–ï–í–Ü–†–ö–ê –ü–Ü–î–¢–†–ò–ú–ö–ò –õ–Ü–•–¢–ê–†–ò–ö–ê
function checkTorch() {
    if (!videoStream) return;
    try {
        const track = videoStream.getVideoTracks()[0];
        const caps = track.getCapabilities();
        if (caps && caps.torch) {
            torchBtn.style.display = "flex";
        }
    } catch (e) { console.log("Torch not supported"); }
}

document.getElementById("addBtn").onclick = ()=>{
    if(process(manualInput.value)){ manualInput.value=""; manualInput.blur(); }
};

manualInput.onkeypress = e=>{ if(e.key==="Enter") document.getElementById("addBtn").click(); };

document.getElementById("undoBtn").onclick = ()=>{
    if(scannedCodes.size === 0) return;
    const arr = Array.from(scannedCodes);
    arr.pop();
    scannedCodes.clear();
    arr.forEach(v => scannedCodes.add(v));
    updateUI();
    vibrate(40);
};

document.getElementById("copyBtn").onclick = function(){
    if(!resultField.value) return;
    navigator.clipboard.writeText(resultField.value).then(() => {
        const originalText = this.textContent;
        this.textContent = "‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!";
        this.style.background = "#d4edda";
        setTimeout(() => { 
            this.textContent = originalText;
            this.style.background = "#e7f3ff";
        }, 1500);
    });
};

function closeModal() { document.getElementById("modal").style.display = "none"; }
document.getElementById("clearAllBtn").onclick = () => { document.getElementById("modal").style.display = "flex"; };
function confirmClear() {
    scannedCodes.clear();
    updateUI();
    closeModal();
}

async function startCamera() {
    try {
        const constraints = { video: { facingMode: "environment" } };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        
        video.srcObject = stream;
        videoStream = stream;
        
        await video.play();
        setTimeout(checkTorch, 1000);

        codeReader.decodeFromVideoDevice(null, video, (res, err) => {
            if (res && !scanCooldown) {
                if (process(res.text)) {
                    scanCooldown = true;
                    setTimeout(() => scanCooldown = false, 1500);
                }
            }
        });
    } catch (err) {
        console.error("Camera Error:", err);
        alert("–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ–∑–≤–æ–ª–∏ —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞.");
    }
}

torchBtn.onclick = async () => {
    if (!videoStream) return;
    try {
        const track = videoStream.getVideoTracks()[0];
        isTorchOn = !isTorchOn;
        await track.applyConstraints({ advanced:[{ torch:isTorchOn }] });
        torchBtn.innerHTML = isTorchOn ? "üî¶ –í–∏–º–∫–Ω—É—Ç–∏" : "üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫";
    } catch(e) { console.error(e); }
};

const saved = localStorage.getItem(STORAGE_KEY);
if(saved){ JSON.parse(saved).forEach(v => scannedCodes.add(v)); updateUI(); }

startCamera();
</script>
</body>
</html>

