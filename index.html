<!DOCTYPE html> 
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–°–ö–ê–ù–ï–† 412</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

    <script src="https://unpkg.com/@zxing/library@latest"></script>

    <style>
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        html, body { margin:0; padding:0; overflow:hidden; height:100%; font-family: -apple-system, system-ui, sans-serif; background:#f8f9fa; }

        h2 { text-align:center; margin:10px 0; font-weight:700; color: #1a1a1a; }

        video {
            width: 100%;
            max-width: 600px;
            height: 22vh;
            border-radius: 12px;
            background:#000;
            margin:auto;
            display:block;
            object-fit:cover;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .manual-input-group {
            max-width:600px; margin:auto; display:flex; gap:8px; padding:10px 12px 0;
        }
        #manualInput {
            flex:1; font-size:16px; padding:12px; border-radius:10px; border:1px solid #ccc; user-select:text;
        }
        #addBtn {
            padding:0 18px; border-radius:10px; border:none; background:#4caf50; color:white; font-size:20px; cursor: pointer;
        }

        #counter {
            text-align:center; margin:6px 0; font-size:14px; font-weight:600; color: #495057;
        }

        textarea {
            width: calc(100% - 24px); max-width:600px; height: 160px; margin:auto; display:block; padding:12px;
            border-radius:12px; border:1px solid #ced4da; font-size:16px; resize:none; background:white;
            user-select:text; white-space:pre; font-family: monospace;
        }

        .controls { max-width:600px; margin:8px auto; display:flex; flex-direction:column; gap:8px; padding:0 12px; }

        /* –í–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ä—è–¥–æ–∫ –∫–Ω–æ–ø–æ–∫ */
        .row { display:flex; gap:8px; width: 100%; }
        
        button { 
            padding:14px; border-radius:12px; border:1px solid #ced4da; font-weight:600; 
            background:white; cursor: pointer; transition: opacity 0.2s;
        }
        button:active { opacity: 0.7; }

        /* –ö–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥–∫—É —Ä–æ–∑—Ç—è–≥—É—é—Ç—å—Å—è –æ–¥–Ω–∞–∫–æ–≤–æ */
        #torchBtn, #undoBtn { flex: 1; }

        /* –í–∞–∂–ª–∏–≤–æ: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ flex –∑–∞–º—ñ—Å—Ç—å block –¥–ª—è –ª—ñ—Ö—Ç–∞—Ä–∏–∫–∞ */
        #torchBtn { display:none; background:#fff3cd; border-color:#ffeeba; color:#856404; }
        
        #undoBtn { background:#e9ecef; }
        #copyBtn { background:#e7f3ff; border-color:#cfe2ff; color:#0056b3; }
        .clearBtn { background:#fff5f5; border-color:#fad2cf; color:#d93025; }

    </style>
</head>
<body>

<h2>–°–ö–ê–ù–ï–† 412</h2>

<video id="video"></video>

<audio id="beep" preload="auto">
  <source src="https://raw.githubusercontent.com/renzofiorella/barcode-scanner-pwa/master/src/assets/beep.mp3" type="audio/mpeg">
</audio>

<div class="manual-input-group">
    <input id="manualInput" type="tel" placeholder="–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É..." inputmode="numeric">
    <button id="addBtn">‚ûï</button>
</div>

<div id="counter">–í—Å—å–æ–≥–æ –≤—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω–æ: 0</div>

<textarea id="result" readonly placeholder="–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π..."></textarea>

<div class="controls">
    <div class="row">
        <button id="torchBtn">üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫</button>
        <button id="undoBtn">‚Ü© –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
    <button id="copyBtn">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤—Å–µ</button>
    <button class="clearBtn" id="clearAllBtn">üóë –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
</div>

<script>
const STORAGE_KEY = "scanner412_codes";
const codeReader = new ZXing.BrowserBarcodeReader();
const video = document.getElementById("video");
const manualInput = document.getElementById("manualInput");
const resultField = document.getElementById("result");
const counter = document.getElementById("counter");
const torchBtn = document.getElementById("torchBtn");
let videoStream = null;
let isTorchOn = false;
let scanCooldown = false;

const scannedCodes = new Set();

function beep(){
    const a = document.getElementById("beep");
    if(a) { a.currentTime = 0; a.play().catch(()=>{}); }
}

function loadSaved(){
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved){
        JSON.parse(saved).forEach(v => scannedCodes.add(v));
        updateUI();
    }
}

function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(scannedCodes)));
}

function updateUI(){
    resultField.value = Array.from(scannedCodes).join("\n");
    counter.textContent = `–í—Å—å–æ–≥–æ –≤—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω–æ: ${scannedCodes.size}`;
    resultField.scrollTop = resultField.scrollHeight;
    save();
}

function vibrate(){ if("vibrate" in navigator) navigator.vibrate(60); }

function process(code){
    code = code.trim();
    if(!code || scannedCodes.has(code)) return false;
    scannedCodes.add(code);
    updateUI();
    vibrate();
    beep();
    return true;
}

document.getElementById("addBtn").onclick = ()=>{
    if(process(manualInput.value)){
        manualInput.value="";
    } else if(manualInput.value.trim()!==""){
        alert("–í–∂–µ —î –∞–±–æ –ø–æ—Ä–æ–∂–Ω—å–æ!");
    }
};

manualInput.onkeypress = e=>{
    if(e.key==="Enter") document.getElementById("addBtn").click();
};

document.getElementById("undoBtn").onclick = ()=>{
    if(scannedCodes.size === 0) return;
    const arr = Array.from(scannedCodes);
    arr.pop();
    scannedCodes.clear();
    arr.forEach(v => scannedCodes.add(v));
    updateUI();
    vibrate();
};

document.getElementById("copyBtn").onclick = function(){
    if(!resultField.value) return;
    navigator.clipboard.writeText(resultField.value).then(() => {
        const originalText = this.textContent;
        this.textContent = "‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!";
        setTimeout(() => this.textContent = originalText, 1500);
    });
    vibrate();
};

document.getElementById("clearAllBtn").onclick = ()=>{
    if(confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫?")) {
        scannedCodes.clear();
        updateUI();
    }
};

async function toggleTorch(){
    try{
        const track = videoStream.getVideoTracks()[0];
        isTorchOn = !isTorchOn;
        await track.applyConstraints({ advanced:[{ torch:isTorchOn }] });
        torchBtn.innerHTML = isTorchOn ? "üî¶ –í–∏–º–∫–Ω—É—Ç–∏" : "üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫";
    }catch(e){ console.error(e); }
}

torchBtn.onclick = toggleTorch;

function checkTorch(){
    try{
        const track = videoStream.getVideoTracks()[0];
        const caps = track.getCapabilities();
        if(caps && caps.torch) {
            torchBtn.style.display = "flex"; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ flex –¥–ª—è –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è
            torchBtn.style.justifyContent = "center";
            torchBtn.style.alignItems = "center";
        }
    }catch(e){}
}

async function startCamera(){
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video:{ facingMode:"environment" },
            audio:false
        });
        video.srcObject = stream;
        videoStream = stream;
        video.play();
        setTimeout(checkTorch, 1000);

        codeReader.decodeFromVideoDevice(null, video, (res)=>{
            if(res && !scanCooldown){
                if(process(res.text)){
                    scanCooldown = true;
                    setTimeout(() => scanCooldown = false, 1500);
                }
            }
        });
    } catch (err) {
        alert("–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏: " + err);
    }
}

loadSaved();
startCamera();
</script>
</body>
</html>
