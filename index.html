<!DOCTYPE html> 
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–°–ö–ê–ù–ï–† 412 PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <script src="zxing.js"></script>

    <style>
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        html, body { margin:0; padding:0; overflow:hidden; height:100%; font-family: -apple-system, sans-serif; background:#000; }

        h2 { text-align:center; margin:10px 0; font-weight:700; color: #fff; font-size: 20px; position: absolute; width: 100%; top: 0; z-index: 10; }

        .video-container { position: relative; width: 100%; height: 35vh; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* –†–∞–º–∫–∞ –¥–ª—è –¥–æ–≤–≥–∏—Ö –∫–æ–¥—ñ–≤ Code 128 */
        .scan-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; pointer-events: none;
        }
        .scan-region {
            width: 85%; height: 40%;
            border: 3px solid #4caf50; border-radius: 12px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
            position: relative;
        }
        .scan-region::after {
            content: ""; position: absolute; top: 50%; left: 0; width: 100%;
            height: 2px; background: #ff0000; box-shadow: 0 0 10px #ff0000;
            animation: scan-line 2.5s infinite ease-in-out;
        }
        @keyframes scan-line { 0% { top: 20%; } 50% { top: 80%; } 100% { top: 20%; } }

        .app-body { 
            background: #f8f9fa; height: 67vh; border-radius: 20px 20px 0 0; 
            position: relative; z-index: 5; margin-top: -20px; padding: 15px;
            display: flex; flex-direction: column; box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
        }

        .manual-input-group { display:flex; gap:10px; margin-bottom: 10px; }
        #manualInput { flex:1; font-size:18px; padding:15px; border-radius:12px; border:1px solid #ccc; user-select: text; }
        #addBtn { padding:0 25px; border-radius:12px; border:none; background:#4caf50; color:white; font-size:24px; }

        #counter { text-align:center; margin-bottom: 8px; font-weight:700; color: #495057; font-size: 16px; }

        textarea {
            flex: 1; width: 100%; margin-bottom: 10px; padding:12px;
            border-radius:12px; border:1px solid #ced4da; font-size:18px; resize:none;
            font-family: 'Courier New', monospace; background: #fff; color: #000; user-select: text;
        }

        .controls { display:flex; flex-direction:column; gap:8px; }
        .row { display:flex; gap:8px; }
        button { padding: 18px; border-radius: 14px; border: 1px solid #ced4da; font-weight: 700; font-size: 18px; background: #fff; cursor: pointer; }
        #torchBtn { display:none; background:#fff3cd; flex:1; border-color: #ffeeba; }
        #undoBtn { background:#e9ecef; flex:1; }
        #copyBtn { background:#e7f3ff; color:#0056b3; border-color: #cfe2ff; }
        .clearBtn { background:#fff5f5; color:#d93025; border-color: #fad2cf; }

        #modal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.7); z-index:2000; justify-content:center; align-items:center;
            backdrop-filter: blur(3px);
        }
        .modal-box { background:white; padding:30px; border-radius:24px; text-align:center; width:85%; max-width:400px; }
    </style>
</head>
<body>

<h2>–°–ö–ê–ù–ï–† 412 PRO</h2>

<div class="video-container">
    <video id="video" autoplay muted playsinline></video>
    <div class="scan-overlay">
        <div class="scan-region"></div>
    </div>
</div>

<div class="app-body">
    <div class="manual-input-group">
        <input id="manualInput" type="tel" placeholder="–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É..." inputmode="numeric">
        <button id="addBtn">‚ûï</button>
    </div>

    <div id="counter">–í—Å—å–æ–≥–æ –≤—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω–æ: 0</div>
    <textarea id="result" readonly placeholder="–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π..."></textarea>

    <div class="controls">
        <div class="row">
            <button id="torchBtn">üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫</button>
            <button id="undoBtn">‚Ü© –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
        <button id="copyBtn">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤—Å–µ</button>
        <button class="clearBtn" id="clearAllBtn">üóë –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
    </div>
</div>

<div id="modal">
    <div class="modal-box">
        <h3 style="margin-top:0">–û—á–∏—Å—Ç–∏—Ç–∏ —Å–ø–∏—Å–æ–∫?</h3>
        <div class="row">
            <button onclick="closeModal()" style="flex:1">–ù–∞–∑–∞–¥</button>
            <button onclick="confirmClear()" style="flex:1; background:#d93025; color:white; border:none">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </div>
    </div>
</div>

<audio id="beep" preload="auto">
  <source src="https://raw.githubusercontent.com/renzofiorella/barcode-scanner-pwa/master/src/assets/beep.mp3" type="audio/mpeg">
</audio>

<script>
const STORAGE_KEY = "scanner412_codes";

// --- –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø –î–õ–Ø –í–ê–ñ–ö–ò–• CODE 128 ---
const hints = new Map();
hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
    ZXing.BarcodeFormat.CODE_128,
    ZXing.BarcodeFormat.CODE_39,
    ZXing.BarcodeFormat.ITF,
    ZXing.BarcodeFormat.EAN_13
]);
hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
// –î–æ–¥–∞—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É –ø—Ä–æ —Ç–µ, —â–æ –∫–æ–¥ –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ –≤ —Ü–µ–Ω—Ç—Ä—ñ –∞–±–æ –¥–µ—Ñ–æ—Ä–º–æ–≤–∞–Ω–∏–π
hints.set(ZXing.DecodeHintType.PURE_BARCODE, false); 

const codeReader = new ZXing.BrowserBarcodeReader(hints);
const video = document.getElementById("video");
const resultField = document.getElementById("result");
const counter = document.getElementById("counter");
const torchBtn = document.getElementById("torchBtn");
let videoStream = null;
let scanCooldown = false;
const scannedCodes = new Set();

async function startCamera() {
    try {
        const constraints = { 
            video: { 
                facingMode: "environment",
                width: { ideal: 1920 },
                height: { ideal: 1080 },
                focusMode: "continuous"
            } 
        };
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = videoStream;
        await video.play();
        
        setTimeout(checkTorch, 1500);

        // –ó–±—ñ–ª—å—à—É—î–º–æ —ñ–Ω—Ç–µ—Ä–≤–∞–ª –º—ñ–∂ —Å–ø—Ä–æ–±–∞–º–∏ –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è, —â–æ–± –ø–æ–∫—Ä–∞—â–∏—Ç–∏ —è–∫—ñ—Å—Ç—å –∞–Ω–∞–ª—ñ–∑—É –∫–æ–∂–Ω–æ–≥–æ –∫–∞–¥—Ä—É
        codeReader.decodeFromVideoDevice(null, video, (res) => {
            if (res && !scanCooldown) {
                if (process(res.text)) {
                    scanCooldown = true;
                    setTimeout(() => scanCooldown = false, 1500);
                }
            }
        });
    } catch (err) {
        alert("–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.");
    }
}

function process(code) {
    code = code.trim();
    if (!code || scannedCodes.has(code)) return false;
    scannedCodes.add(code);
    updateUI();
    if("vibrate" in navigator) navigator.vibrate(100);
    document.getElementById("beep").play().catch(()=>{});
    return true;
}

function updateUI() {
    resultField.value = Array.from(scannedCodes).join("\n");
    counter.textContent = `–í—Å—å–æ–≥–æ –≤—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω–æ: ${scannedCodes.size}`;
    resultField.scrollTop = resultField.scrollHeight;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(scannedCodes)));
}

function checkTorch() {
    try {
        const track = videoStream.getVideoTracks()[0];
        const caps = track.getCapabilities();
        if (caps && caps.torch) torchBtn.style.display = "flex";
    } catch(e) {}
}

torchBtn.onclick = async () => {
    try {
        const track = videoStream.getVideoTracks()[0];
        const state = torchBtn.innerText.includes("–í–∏–º–∫–Ω—É—Ç–∏");
        await track.applyConstraints({ advanced: [{ torch: !state }] });
        torchBtn.innerHTML = !state ? "üî¶ –í–∏–º–∫–Ω—É—Ç–∏" : "üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫";
    } catch(e) {}
};

document.getElementById("addBtn").onclick = () => {
    const val = document.getElementById("manualInput").value.trim();
    if(process(val)) document.getElementById("manualInput").value = "";
};

document.getElementById("undoBtn").onclick = () => {
    const arr = Array.from(scannedCodes);
    if(arr.length > 0) {
        arr.pop();
        scannedCodes.clear();
        arr.forEach(v => scannedCodes.add(v));
        updateUI();
    }
};

document.getElementById("copyBtn").onclick = function() {
    if(!resultField.value) return;
    navigator.clipboard.writeText(resultField.value);
    this.innerText = "‚úÖ –ì–æ—Ç–æ–≤–æ!";
    setTimeout(() => this.innerText = "üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤—Å–µ", 1500);
};

document.getElementById("clearAllBtn").onclick = () => document.getElementById("modal").style.display = "flex";
function closeModal() { document.getElementById("modal").style.display = "none"; }
function confirmClear() { scannedCodes.clear(); updateUI(); closeModal(); }

const saved = localStorage.getItem(STORAGE_KEY);
if(saved) { JSON.parse(saved).forEach(v => scannedCodes.add(v)); updateUI(); }

startCamera();
</script>
</body>
</html>
