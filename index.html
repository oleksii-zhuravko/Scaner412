<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–°–ö–ê–ù–ï–† 412</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f5f5f5">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://unpkg.com/@zxing/library@latest"></script>

    <style>
        * { 
            -webkit-touch-callout: none; 
            -webkit-user-select: none; 
            user-select: none; 
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* –ó–∞–±–æ—Ä–æ–Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–æ—ó –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
            overscroll-behavior: none; /* –í–∏–º–∏–∫–∞—î –µ—Ñ–µ–∫—Ç "–≥—É–º–∏" –Ω–∞ iOS */
        }

        body {
            font-family: Arial, sans-serif; 
            padding: 15px; 
            background: #f5f5f5;
            display: flex; 
            flex-direction: column; 
            align-items: center;
            touch-action: none; 
        }

        h2 { margin: 5px 0; user-select: none; }

        video {
            width: 100%; 
            max-width: 600px; 
            height: 25vh; 
            border-radius: 8px;
            margin-bottom: 10px; 
            object-fit: cover; 
            background: #000;
        }
        
        .manual-input-group {
            width: 100%; max-width: 600px; display: flex; gap: 5px; margin-bottom: 10px;
        }

        #manualInput {
            flex: 1; padding: 12px; font-size: 16px; border-radius: 8px;
            border: 2px solid #ccc; -webkit-user-select: text; user-select: text;
            background: #fff;
        }

        #addBtn {
            width: auto; padding: 0 20px; background: #4CAF50; color: white; border: none; font-size: 20px;
            border-radius: 8px; cursor: pointer;
        }

        #counter { font-weight: bold; margin-bottom: 5px; }

        textarea {
            width: 100%; max-width: 600px; height: 150px;
            font-size: 16px; margin-bottom: 10px; white-space: pre;
            border: 2px solid #ccc; border-radius: 8px; padding: 10px; resize: none;
            -webkit-user-select: text; user-select: text; touch-action: pan-y; 
            background: #fff;
        }

        .controls { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 8px; }

        button {
            padding: 15px; width: 100%; font-size: 18px; cursor: pointer;
            border-radius: 8px; border: 1px solid #ddd; background: #fff;
            touch-action: manipulation; -webkit-tap-highlight-color: transparent;
        }

        #torchBtn { display: none; background: #fff3cd; border-color: #ffeeba; }
    </style>
</head>
<body>

<h2>–°–ö–ê–ù–ï–† 412</h2>

<video id="video"></video>

<div class="manual-input-group">
    <input type="tel" id="manualInput" placeholder="–¶–∏—Ñ—Ä–∏ –≤—Ä—É—á–Ω—É..." autocomplete="off" inputmode="numeric" pattern="[0-9]*">
    <button id="addBtn" onclick="addManualCode()">‚ûï</button>
</div>

<div id="counter">–í—Å—å–æ–≥–æ: 0</div>
<textarea id="result" readonly placeholder="–í—ñ–¥—Å–∫–∞–Ω–æ–≤–∞–Ω—ñ –Ω–æ–º–µ—Ä–∏..."></textarea>

<div class="controls">
    <button id="torchBtn" onclick="toggleTorch()">üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫: –í–ò–ú–ö</button>
    <button onclick="copyData()" style="background: #e7f3ff;">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤—Å–µ</button>
    <button onclick="clearData()">üóë –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
</div>

<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(err => console.log(err));
    }

    // --- –§–Ü–ö–° –ó–°–£–í–£ –°–¢–û–†–Ü–ù–ö–ò ---
    const manualInput = document.getElementById('manualInput');
    
    manualInput.addEventListener('blur', () => {
        // –ö–æ–ª–∏ —Ñ–æ–∫—É—Å –∑–Ω–∏–∫–∞—î (–∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è), –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤–≥–æ—Ä—É
        setTimeout(() => {
            window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
        }, 100);
    });

    // –ó–∞–±–æ—Ä–æ–Ω–∞ –∑—É–º—É
    document.addEventListener('touchmove', e => { if (e.scale !== 1) e.preventDefault(); }, { passive: false });
    let lastTouchEnd = 0;
    document.addEventListener('touchend', e => {
        let now = Date.now();
        if (now - lastTouchEnd <= 300) e.preventDefault();
        lastTouchEnd = now;
    }, false);

    const STORAGE_KEY = 'scanner412_codes';
    const codeReader = new ZXing.BrowserBarcodeReader();
    const videoElement = document.getElementById('video');
    const resultField = document.getElementById('result');
    const counter = document.getElementById('counter');
    const torchBtn = document.getElementById('torchBtn');

    const scannedCodes = new Set();
    let scanTimeout = false;
    let videoStream = null;
    let isTorchOn = false;

    function scrollToBottom() { resultField.scrollTop = resultField.scrollHeight; }

    function updateDisplay() {
        resultField.value = Array.from(scannedCodes).join('\n');
        counter.textContent = `–í—Å—å–æ–≥–æ: ${scannedCodes.size}`;
        scrollToBottom();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(scannedCodes)));
    }

    const savedData = localStorage.getItem(STORAGE_KEY);
    if (savedData) {
        JSON.parse(savedData).forEach(code => scannedCodes.add(code));
        updateDisplay();
    }

    function processCode(code) {
        code = code.trim();
        if (!code || scannedCodes.has(code)) return false;
        scannedCodes.add(code);
        updateDisplay();
        playBeep();
        return true;
    }

    function addManualCode() {
        if (processCode(manualInput.value)) {
            manualInput.value = '';
            manualInput.blur(); // –ó–∞–∫—Ä–∏—Ç–∏ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è
        } else if (manualInput.value.trim() !== "") {
            alert("–î—É–±–ª—ñ–∫–∞—Ç!");
        }
    }

    manualInput.addEventListener('keypress', (e) => { 
        if (e.key === 'Enter') addManualCode(); 
    });

    codeReader.decodeFromVideoDevice(null, videoElement, (result, err) => {
        if (!videoStream && videoElement.srcObject) {
            videoStream = videoElement.srcObject;
            setTimeout(checkTorchSupport, 800); // –¢—Ä–æ—Ö–∏ –±—ñ–ª—å—à–µ —á–∞—Å—É –¥–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
        }
        if (result && !scanTimeout) {
            if (processCode(result.text)) {
                scanTimeout = true;
                setTimeout(() => scanTimeout = false, 1500);
            }
        }
    });

    async function checkTorchSupport() {
        try {
            const track = videoStream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();
            if (capabilities && capabilities.torch) {
                torchBtn.style.display = 'block';
            }
        } catch (e) { console.log("Torch error:", e); }
    }

    async function toggleTorch() {
        try {
            const track = videoStream.getVideoTracks()[0];
            isTorchOn = !isTorchOn;
            await track.applyConstraints({ advanced: [{ torch: isTorchOn }] });
            torchBtn.innerText = isTorchOn ? "üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫: –£–í–Ü–ú–ö" : "üî¶ –õ—ñ—Ö—Ç–∞—Ä–∏–∫: –í–ò–ú–ö";
            torchBtn.style.background = isTorchOn ? "#ffc107" : "#fff3cd";
        } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞ –ª—ñ—Ö—Ç–∞—Ä–∏–∫–∞"); }
    }

    function playBeep() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = 800; gain.gain.value = 0.1;
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); setTimeout(() => { osc.stop(); audioCtx.close(); }, 80);
        } catch (e) {}
    }

    function copyData() {
        if (!resultField.value) return;
        navigator.clipboard.writeText(resultField.value).then(() => alert('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!'));
    }

    function clearData() {
        if(confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ?")) {
            scannedCodes.clear();
            updateDisplay();
            localStorage.removeItem(STORAGE_KEY);
        }
    }
</script>
</body>
</html>
